# MQ 发送及消费处理细节
- 本文主要针对 MQ 使用中的部分细节进行分析. 

## 记录
- 首先在使用MQ时对数据或者参数的记录很重要. 
    那么在那些时刻需要记录呢? 记录什么内容?
    针对这个问题应从 **消息生产者(Producer)** 和 **消息消费者(Consumer)** 来进行大方向的思考. 
    
    
    
### 消息生产者
深入 **消息生产者**, 消息生产者会有下面这些时间节点
    1. 消息发送前, 记录消息id(唯一id), 记录发送的消息体
    1. 消息发送后
        1. 消息成功消费后, 记录消息id(唯一id),处理者标识,处理结果.
        1. 消息消费失败后, 记录消息id(唯一id),处理者标识,处理结果.

### 消息消费者
深入 **消息消费者**, 消息消费者记录时间点
    1. 消息到达时, 记录消息id(唯一id), 记录发送的消息体.
    1. 消息处理前, 记录消息id(唯一id). 
    1. 消息处理后, 记录消息id(唯一id), 记录消息处理结果.

主要记录项目如上文所述.

## 消息生产者
- 这部分主要详细介绍消息生产者的细节处理. 
### 记录
- 前文说到需要对消息发送进行日志记录. 这里主要讲述记录方式


#### 数据库+redis
记录最直接的方式有写入 **数据库** , 但是在高峰时写入数据库会造成不好的影响. 如
    1. 占据大量文件写入I/O

在此时需要接入批量插入的形式. 使用 redis 做一层缓冲. 先将需要记录的数据写入 redis , 等到达一定数量后在一次性写入数据库. 


### ELK 
- 接入ELK通过ELK来进行数据收集, 且ELK自身提供查询功能, 但ELK相对而言硬件成本较高. 



### 幂等
- 根据业务来决定是否需要幂等性. 幂等的一种思考方式: 对关键字段做唯一索引, 将其存储,第二条消息进来时判断是否存在. 



### 消息发送失败的处理
- 重发机制. 
- ACK机制. 
- 人工干预. 



